name: Pull Request Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

jobs:
  # PR Metadata Validation
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            if (!pr.body || pr.body.length < 50) {
              core.setFailed('PR description is too short. Please provide a detailed description.');
            }

            // Check for required sections
            const requiredSections = ['## Description', '## Changes', '## Testing'];
            const missingSections = requiredSections.filter(section => !pr.body.includes(section));

            if (missingSections.length > 0) {
              core.warning(`Missing recommended sections: ${missingSections.join(', ')}`);
            }

      - name: Check for linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const hasIssueLink = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#\d+/i.test(pr.body || '');

            if (!hasIssueLink) {
              core.warning('No linked issue found. Consider linking an issue using "Fixes #123" or "Closes #456".');
            }

  # Check for breaking changes
  breaking-changes:
    name: Breaking Changes Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const hasBreakingChange = /BREAKING CHANGE:/i.test(pr.body || '') ||
                                      pr.title.includes('!:');

            if (hasBreakingChange) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['breaking-change']
              });

              core.warning('âš ï¸ This PR contains breaking changes!');
            }

  # Code size and complexity check
  code-size:
    name: Code Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const additions = pr.additions;
            const deletions = pr.deletions;
            const changedFiles = pr.changed_files;

            let size = 'small';
            let label = 'size/small';

            if (additions + deletions > 1000 || changedFiles > 30) {
              size = 'extra-large';
              label = 'size/xl';
              core.warning('âš ï¸ This PR is very large. Consider breaking it into smaller PRs.');
            } else if (additions + deletions > 500 || changedFiles > 20) {
              size = 'large';
              label = 'size/large';
            } else if (additions + deletions > 200 || changedFiles > 10) {
              size = 'medium';
              label = 'size/medium';
            }

            // Remove old size labels
            const oldLabels = ['size/small', 'size/medium', 'size/large', 'size/xl'];
            for (const oldLabel of oldLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: oldLabel
                });
              } catch (error) {
                // Label doesn't exist, ignore
              }
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

            console.log(`PR Size: ${size} (+${additions}/-${deletions}, ${changedFiles} files)`);

  # Check for merge conflicts
  merge-conflicts:
    name: Merge Conflict Check
    runs-on: ubuntu-latest

    steps:
      - name: Check for merge conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            if (pr.mergeable === false) {
              core.setFailed('âŒ This PR has merge conflicts. Please resolve them.');
            } else if (pr.mergeable === null) {
              core.warning('âš ï¸ Merge status unknown. GitHub is still calculating.');
            } else {
              console.log('âœ… No merge conflicts detected');
            }

  # Check for TODOs and FIXMEs
  todo-check:
    name: TODO/FIXME Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for TODOs
        run: |
          # Get changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Search for TODO/FIXME in changed files
          TODO_COUNT=0
          FIXME_COUNT=0

          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              TODOS=$(grep -n "TODO" "$file" | wc -l || true)
              FIXMES=$(grep -n "FIXME" "$file" | wc -l || true)
              TODO_COUNT=$((TODO_COUNT + TODOS))
              FIXME_COUNT=$((FIXME_COUNT + FIXMES))
            fi
          done

          echo "TODOs found: $TODO_COUNT"
          echo "FIXMEs found: $FIXME_COUNT"

          if [ $FIXME_COUNT -gt 0 ]; then
            echo "âš ï¸ Warning: This PR introduces $FIXME_COUNT FIXME comments"
          fi

          if [ $TODO_COUNT -gt 5 ]; then
            echo "âš ï¸ Warning: This PR introduces $TODO_COUNT TODO comments (consider creating issues instead)"
          fi

  # Check for console.log statements
  console-check:
    name: Console Statement Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for console statements
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(js|jsx|ts|tsx)$' || true)

          CONSOLE_COUNT=0

          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              CONSOLES=$(grep -n "console\." "$file" | grep -v "// console\." | wc -l || true)
              CONSOLE_COUNT=$((CONSOLE_COUNT + CONSOLES))
            fi
          done

          echo "Console statements found: $CONSOLE_COUNT"

          if [ $CONSOLE_COUNT -gt 0 ]; then
            echo "âš ï¸ Warning: This PR contains $CONSOLE_COUNT console statements. Consider removing or using proper logging."
          fi

  # Dependency changes check
  dependency-check:
    name: Dependency Changes Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check dependency changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const dependencyFiles = files.filter(file =>
              file.filename.includes('package.json') ||
              file.filename.includes('package-lock.json') ||
              file.filename.includes('pom.xml') ||
              file.filename.includes('requirements.txt')
            );

            if (dependencyFiles.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['dependencies']
              });

              const comment = `## ðŸ“¦ Dependency Changes Detected\n\nThis PR modifies dependencies. Please ensure:\n- [ ] Security vulnerabilities are addressed\n- [ ] License compatibility is verified\n- [ ] Breaking changes are documented\n\nChanged files:\n${dependencyFiles.map(f => `- \`${f.filename}\``).join('\n')}`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  # Auto-labeler
  auto-label:
    name: Auto Label
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto label
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml
          sync-labels: true

  # Check test coverage on changed files
  test-coverage:
    name: Test Coverage Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for test files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          SOURCE_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(java|js|jsx|ts|tsx|py)$' | grep -v test | grep -v spec || true)
          TEST_FILES=$(echo "$CHANGED_FILES" | grep -E '(test|spec)\.(java|js|jsx|ts|tsx|py)$' || true)

          SOURCE_COUNT=$(echo "$SOURCE_FILES" | grep -v '^$' | wc -l)
          TEST_COUNT=$(echo "$TEST_FILES" | grep -v '^$' | wc -l)

          echo "Source files changed: $SOURCE_COUNT"
          echo "Test files changed: $TEST_COUNT"

          if [ "$SOURCE_COUNT" -gt 0 ] && [ "$TEST_COUNT" -eq 0 ]; then
            echo "âš ï¸ Warning: Source code was modified but no test files were updated"
            exit 0  # Warning only, don't fail
          fi

  # Performance impact check
  performance-check:
    name: Performance Impact Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for performance-sensitive changes
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check for database migration files
          DB_MIGRATIONS=$(echo "$CHANGED_FILES" | grep -E 'migration|flyway|liquibase' || true)

          if [ -n "$DB_MIGRATIONS" ]; then
            echo "âš ï¸ Database migration detected - performance testing recommended"
          fi

          # Check for loop or query changes
          PERF_PATTERNS="for.*in|while|SELECT|INSERT|UPDATE|DELETE"
          git diff origin/${{ github.base_ref }}...HEAD | grep -E "$PERF_PATTERNS" > /dev/null && \
            echo "âš ï¸ Performance-sensitive code patterns detected" || true

  # PR validation summary
  pr-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-metadata, code-size, merge-conflicts, todo-check, dependency-check]
    if: always()

    steps:
      - name: Create PR comment with summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'PR Metadata': '${{ needs.pr-metadata.result }}',
              'Code Size': '${{ needs.code-size.result }}',
              'Merge Conflicts': '${{ needs.merge-conflicts.result }}',
              'TODO Check': '${{ needs.todo-check.result }}',
              'Dependency Check': '${{ needs.dependency-check.result }}'
            };

            const passed = Object.values(results).filter(r => r === 'success').length;
            const failed = Object.values(results).filter(r => r === 'failure').length;
            const total = Object.keys(results).length;

            let summary = `## âœ… PR Validation Summary\n\n`;
            summary += `**Status**: ${passed}/${total} checks passed\n\n`;
            summary += `### Check Results:\n\n`;

            for (const [check, result] of Object.entries(results)) {
              const emoji = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'âš ï¸';
              summary += `- ${emoji} ${check}: ${result}\n`;
            }

            if (failed === 0) {
              summary += `\nðŸŽ‰ All validation checks passed! This PR is ready for review.`;
            } else {
              summary += `\nâš ï¸ Some validation checks failed. Please review and address the issues above.`;
            }

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('PR Validation Summary')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
